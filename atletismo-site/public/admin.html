<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Lista de Inscritos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex flex-col min-h-screen">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Painel de Controle</h1>
                    <p class="text-sm text-gray-500">Corrida de Atletismo 2025</p>
                </div>
                <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all transform hover:scale-105">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </a>
            </div>
        </header>

        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            
             <div class="mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-inscricoes" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-500">
                            Inscrições
                        </button>
                        <button id="tab-galeria" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Gerenciar Galeria
                        </button>
                    </nav>
                </div>
            </div>

            <div id="section-inscricoes">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4 transition-all hover:shadow-xl hover:-translate-y-1">
                        <div class="bg-blue-100 text-blue-600 p-4 rounded-full">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total de Inscrições</p>
                            <p id="total-inscritos" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4 transition-all hover:shadow-xl hover:-translate-y-1">
                        <div class="bg-green-100 text-green-600 p-4 rounded-full">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Pagamentos Confirmados</p>
                            <p id="pagamentos-confirmados" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4 transition-all hover:shadow-xl hover:-translate-y-1">
                        <div class="bg-yellow-100 text-yellow-600 p-4 rounded-full">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Arrecadado</p>
                            <p id="total-arrecadado" class="text-3xl font-bold text-gray-800">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <main class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 flex flex-wrap items-center justify-between gap-4 border-b bg-gray-50">
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Buscar por nome ou CPF..." class="pl-10 pr-4 py-2 border rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <select id="status-filter" class="border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="todos">Todos os Status</option>
                                <option value="approved">Aprovado</option>
                                <option value="pending">Pendente</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                             <button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all">
                                <i class="fas fa-file-csv mr-2"></i> CSV
                            </button>
                            <button id="export-pdf" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all">
                                <i class="fas fa-file-pdf mr-2"></i> PDF
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-600 uppercase text-sm">
                                <tr>
                                    <th class="p-4 font-semibold">ID</th>
                                    <th class="p-4 font-semibold">Nome</th>
                                    <th class="p-4 font-semibold hidden lg:table-cell">WhatsApp</th>
                                    <th class="p-4 font-semibold hidden lg:table-cell">CPF</th>
                                    <th class="p-4 font-semibold">Camisa</th>
                                    <th class="p-4 font-semibold hidden md:table-cell">Gênero</th>
                                    <th class="p-4 font-semibold hidden sm:table-cell">Faixa Etária</th>
                                    <th class="p-4 font-semibold hidden md:table-cell">Cidade</th>
                                    <th class="p-4 font-semibold">Status</th>
                                    <th class="p-4 font-semibold text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-inscritos" class="divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </main>
            </div>

            <div id="section-galeria" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Gerenciar Galeria de Imagens</h2>
                    
                    <form id="upload-form" class="mb-8 p-6 border rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-4">Adicionar Nova Imagem</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="file" id="imagem-input" name="imagem" required class="flex-grow block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            <button type="submit" id="upload-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all">
                                <i class="fas fa-upload mr-2"></i> Enviar
                            </button>
                        </div>
                    </form>

                    <h3 class="text-lg font-semibold mb-4">Imagens Enviadas</h3>
                    <div id="gallery-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                         </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTOS COMUNS E ABAS ---
    const tabInscricoes = document.getElementById('tab-inscricoes');
    const tabGaleria = document.getElementById('tab-galeria');
    const sectionInscricoes = document.getElementById('section-inscricoes');
    const sectionGaleria = document.getElementById('section-galeria');

    // --- ELEMENTOS DAS INSCRIÇÕES ---
    const tabelaBody = document.getElementById('tabela-inscritos');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const exportCsvButton = document.getElementById('export-csv');
    const exportPdfButton = document.getElementById('export-pdf');
    const totalInscritosEl = document.getElementById('total-inscritos');
    const pagamentosConfirmadosEl = document.getElementById('pagamentos-confirmados');
    const totalArrecadadoEl = document.getElementById('total-arrecadado');
    let allInscritos = [];

    // --- ELEMENTOS DA GALERIA ---
    const uploadForm = document.getElementById('upload-form');
    const imageInput = document.getElementById('imagem-input');
    const uploadButton = document.getElementById('upload-button');
    const galleryContainer = document.getElementById('gallery-container');

    // --- LÓGICA DE NAVEGAÇÃO POR ABAS ---
    function showSection(sectionToShow) {
        [sectionInscricoes, sectionGaleria].forEach(section => section.classList.add('hidden'));
        [tabInscricoes, tabGaleria].forEach(tab => {
            tab.classList.remove('text-blue-600', 'border-blue-500');
            tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        
        if (sectionToShow === 'inscricoes') {
            sectionInscricoes.classList.remove('hidden');
            tabInscricoes.classList.add('text-blue-600', 'border-blue-500');
        } else {
            sectionGaleria.classList.remove('hidden');
            tabGaleria.classList.add('text-blue-600', 'border-blue-500');
        }
    }
    tabInscricoes.addEventListener('click', () => showSection('inscricoes'));
    tabGaleria.addEventListener('click', () => showSection('galeria'));


    // --- LÓGICA DAS INSCRIÇÕES ---
    async function carregarInscritos() {
        tabelaBody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando...</td></tr>`;
        try {
            const response = await fetch('/api/inscritos');
            if (!response.ok) throw new Error('Falha ao carregar dados dos inscritos.');
            allInscritos = await response.json();
            renderTable();
        } catch (error) {
            console.error('Erro:', error);
            tabelaBody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-red-500">${error.message}</td></tr>`;
        }
    }

    function renderTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const status = statusFilter.value;
        const filteredInscritos = allInscritos.filter(inscrito => {
            const nameMatch = inscrito.nome.toLowerCase().includes(searchTerm);
            const cpfMatch = inscrito.cpf.includes(searchTerm);
            const statusMatch = (status === 'todos') || ((inscrito.pagamento?.status || 'pending') === status);
            return (nameMatch || cpfMatch) && statusMatch;
        });

        updateSummary(filteredInscritos);
        tabelaBody.innerHTML = '';
        if (filteredInscritos.length === 0) {
            tabelaBody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-gray-500">Nenhum inscrito.</td></tr>`;
            return;
        }

        filteredInscritos.forEach(inscrito => {
            const statusPagamento = getStatusBadge(inscrito.pagamento);
            const linha = `
                <tr class="hover:bg-gray-50 transition-all text-sm text-gray-700">
                    <td class="p-4 font-medium text-gray-900">${inscrito.id}</td>
                    <td class="p-4">${inscrito.nome}</td>
                    <td class="p-4 hidden lg:table-cell">${inscrito.telefone}</td>
                    <td class="p-4 hidden lg:table-cell">${inscrito.cpf}</td>
                    <td class="p-4 font-bold text-center">${inscrito.tamanho_camisa || 'N/A'}</td>
                    <td class="p-4 hidden md:table-cell">${inscrito.genero || 'N/A'}</td>
                    <td class="p-4 hidden sm:table-cell">${inscrito.faixa_etaria || 'N/A'}</td>
                    <td class="p-4 hidden md:table-cell">${inscrito.cidade}</td>
                    <td class="p-4">${statusPagamento}</td>
                    <td class="p-4 text-center">
                        <button class="text-red-500 hover:text-red-700 delete-inscrito-btn" data-id="${inscrito.id}" data-nome="${inscrito.nome}" title="Excluir Inscrição">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
            tabelaBody.innerHTML += linha;
        });
    }

    function updateSummary(inscritos) {
        const confirmados = inscritos.filter(i => i.pagamento?.status === 'approved');
        const totalValor = confirmados.reduce((sum, i) => sum + (i.pagamento.valor || 0), 0);
        totalInscritosEl.textContent = inscritos.length;
        pagamentosConfirmadosEl.textContent = confirmados.length;
        totalArrecadadoEl.textContent = totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    function getStatusBadge(pagamento) {
        const status = pagamento?.status || 'pending';
        switch (status) {
            case 'approved': return '<span class="bg-green-100 text-green-800 font-semibold px-2 py-1 rounded-full text-xs">Aprovado</span>';
            case 'pending': return '<span class="bg-yellow-100 text-yellow-800 font-semibold px-2 py-1 rounded-full text-xs">Pendente</span>';
            default: return `<span class="bg-red-100 text-red-800 font-semibold px-2 py-1 rounded-full text-xs">${status}</span>`;
        }
    }

    tabelaBody.addEventListener('click', async (event) => {
        const deleteButton = event.target.closest('.delete-inscrito-btn');
        if (deleteButton) {
            const { id, nome } = deleteButton.dataset;
            if (confirm(`Tem certeza que deseja excluir a inscrição de "${nome}"?`)) {
                try {
                    const response = await fetch(`/api/inscritos/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Falha ao excluir.');
                    allInscritos = allInscritos.filter(i => i.id !== parseInt(id));
                    renderTable();
                } catch (error) {
                    console.error("Erro ao excluir:", error);
                    alert("Não foi possível excluir o inscrito.");
                }
            }
        }
    });

    exportCsvButton.addEventListener('click', () => {
    const statusSelecionado = statusFilter.value;
    const inscritosFiltrados = statusSelecionado === "todos"
        ? allInscritos
        : allInscritos.filter(i => i.pagamento?.status === statusSelecionado);

    // Adiciona o BOM para corrigir acentuação no Excel/Windows
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
    csvContent += "ID,Nome,CPF,Tamanho Camisa,Gênero,Faixa Etária,Cidade,Status Pagamento,Valor Pago\r\n";

    inscritosFiltrados.forEach(i => {
        const status = i.pagamento?.status || 'pendente';
        const valor = i.pagamento?.status === 'approved' ? (i.pagamento.valor || 0).toFixed(2) : '0.00';
        const row = [
            `${i.id}`,
            `"${i.nome}"`,
            `"${i.telefone}"`,
            `"${i.cpf}"`,
            `"${i.tamanho_camisa || ''}"`,
            `"${i.genero || ''}"`,
            `"${i.faixa_etaria || ''}"`,
            `"${i.cidade}"`,
            `"${status}"`,
            `"${valor}"`
        ].join(",");
        csvContent += row + "\r\n";
    });

    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `inscricoes_corrida_${statusSelecionado}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
    exportPdfButton.addEventListener('click', () => {
    const status = statusFilter.value;
    window.open(`/api/inscritos/pdf?status=${status}`, '_blank');
});
    searchInput.addEventListener('input', renderTable);
    statusFilter.addEventListener('change', renderTable);
    
    // --- LÓGICA DA GALERIA (AGORA FUNCIONAL) ---
    async function carregarGaleria() {
        galleryContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando imagens...</p>`;
        try {
            const response = await fetch('/api/galeria');
            if (!response.ok) throw new Error('Falha ao carregar galeria.');
            const images = await response.json();
            
            galleryContainer.innerHTML = '';
            if (images.length === 0) {
                galleryContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">Nenhuma imagem na galeria.</p>`;
                return;
            }
            images.forEach(image => {
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'relative group aspect-square';
                imgWrapper.innerHTML = `
                    <img src="${image.caminhoArquivo}" alt="Imagem da Galeria" class="w-full h-full object-cover rounded-lg shadow-md">
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all rounded-lg">
                        <button data-id="${image.id}" class="delete-image-btn text-white text-3xl hover:text-red-500 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                galleryContainer.appendChild(imgWrapper);
            });
        } catch (error) {
            console.error(error);
            galleryContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">Erro ao carregar galeria.</p>`;
        }
    }

    uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (imageInput.files.length === 0) {
            Toastify({ text: "Por favor, selecione uma imagem.", backgroundColor: "#ef4444" }).showToast();
            return;
        }
        const formData = new FormData();
        formData.append('imagem', imageInput.files[0]);
        
        uploadButton.disabled = true;
        uploadButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...`;

        try {
            const response = await fetch('/api/galeria/upload', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) throw new Error('Falha no upload.');
            
            Toastify({ text: "Imagem enviada com sucesso!", backgroundColor: "#22c55e" }).showToast();
            uploadForm.reset();
            carregarGaleria(); // Recarrega a galeria para mostrar a nova imagem
        } catch (error) {
            console.error(error);
            Toastify({ text: "Erro ao enviar imagem.", backgroundColor: "#ef4444" }).showToast();
        } finally {
            uploadButton.disabled = false;
            uploadButton.innerHTML = `<i class="fas fa-upload mr-2"></i> Enviar`;
        }
    });

    galleryContainer.addEventListener('click', async (event) => {
        const deleteButton = event.target.closest('.delete-image-btn');
        if (deleteButton) {
            const imageId = deleteButton.dataset.id;
            if (confirm('Tem certeza que deseja excluir esta imagem?')) {
                try {
                    const response = await fetch(`/api/galeria/${imageId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Falha ao excluir.');
                    
                    Toastify({ text: "Imagem excluída!", backgroundColor: "#22c55e" }).showToast();
                    carregarGaleria(); // Recarrega a galeria
                } catch (error) {
                    console.error(error);
                    Toastify({ text: "Erro ao excluir imagem.", backgroundColor: "#ef4444" }).showToast();
                }
            }
        }
    });

    // --- CARREGAMENTO INICIAL ---
    carregarInscritos();
    carregarGaleria();
});
</script>
</body>
</html>
